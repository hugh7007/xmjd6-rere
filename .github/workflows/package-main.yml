name: Package Main Branch

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    
    - name: Get latest OpenCC pre-release asset URL
      id: get_opencc_url
      uses: actions/github-script@v7
      with:
        script: |
          const releases = await github.rest.repos.listReleases({
            owner: 'amorphobia',
            repo: 'opencc-tonggui',
          });
          const preRelease = releases.data.find(r => r.prerelease);
          if (!preRelease) {
             core.setFailed('No pre-release found for amorphobia/opencc-tonggui');
             return;
          }
          console.log(`Found pre-release tag: ${preRelease.tag_name}`);
          const asset = preRelease.assets.find(a => a.name.endsWith('.zip'));
          if (!asset) {
             core.setFailed('No zip asset found in the pre-release');
             return;
          }
          console.log(`Download URL: ${asset.browser_download_url}`);
          return asset.browser_download_url;

    - name: Download and Setup OpenCC
      run: |
        # 获取 URL
        url="${{ steps.get_opencc_url.outputs.result }}"
        
        # 下载
        echo "Downloading from $url..."
        wget -q -O opencc_temp.zip "$url"
        
        # 解压
        unzip -q opencc_temp.zip -d opencc_extract_temp
        
        # 移动文件 (智能判断解压结构)
        echo "Copying files to opencc/xmjd6/..."
        if [ -d "opencc_extract_temp/opencc" ]; then
            cp -r opencc_extract_temp/opencc/* opencc/xmjd6/
        else
            cp -r opencc_extract_temp/* opencc/xmjd6/
        fi
        
        # 清理临时垃圾
        rm opencc_temp.zip
        rm -rf opencc_extract_temp
        
        # 验证一下
        ls -R opencc/xmjd6/

    - uses: actions/upload-artifact@v4
      with:
        name: xmjd6
        path: |
          **/*
          !.git/**
          !.github/**
          !.git*
          !yong*.*
          !opencc_temp.zip
          !opencc_extract_temp/**
