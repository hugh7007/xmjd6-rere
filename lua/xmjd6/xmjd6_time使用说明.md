# TXJX Rime Lua 模块使用文档

本文档介绍 TXJX 输入法方案中各个 Lua 模块的功能和触发关键字。

## 📅 时间日期模块 (txjx_time.lua)

### 基础日期时间
| 关键字 | 功能 | 输出示例 |
|--------|------|----------|
| `rq` | 多种日期格式 | `2025-11-27`、`2025年11月27日`、农历日期 |
| `ej` | 时间格式 | `18:30:45`、`2025-11-27 18:30:45` |
| `xq` / `oxq` | 星期信息 | `星期三`、`㊂`、`Wed`、`Wednesday` |
| `nl` | 农历信息 | 农历日期、干支纪年、时辰 |
| `jq` / `ojq` | 节气信息 | 当前和下个节气的日期 |

### 快速日期时间
| 关键字 | 功能 | 输出示例 |
|--------|------|----------|
| `oxz` | 报时格式 | `2025-11-27 18:30:45`、`2025年11月27日星期三18点30分45秒` |
| `osj` | 时间 | `18:30:45`、`18点30分45秒` |
| `osf` | 简短时间 | `18:30` |
| `orq` | 日期 | `2025-11-27`、`2025年11月27日` |
| `orqsj` | 日期时间 | `2025-11-27 18:30:45`、`2025年11月27日18点30分45秒` |
| `now` | 当前时间 | 系统格式的完整时间 |

### 特殊功能
| 关键字 | 功能 | 说明 |
|--------|------|------|
| `=YYYYMM` | 日历查询 | 查询指定年月的农历信息，如 `=202511` |
| `sjx/` | 倒计时 | 显示到特定节日的倒计时天数 |

## 🧮 计算器模块 (txjx_jisuanqi.lua)

### 基础计算
| 格式 | 功能 | 输出示例 |
|------|------|----------|
| `=表达式` | 数学计算 | `=1+1` → `2` |
| `=表达式;` | 强制计算 | 在非贪婪模式下强制执行 |

### 支持的函数
- **基础运算**: `+` `-` `*` `/` `^` `%`
- **数学函数**: `sin` `cos` `tan` `asin` `acos` `atan` `sqrt` `exp` `ln` `log`
- **取整函数**: `floor` `ceil` `round` `trunc` `abs`
- **统计函数**: `min` `max` `sum` `avg` `fac` (阶乘)
- **数组函数**: `range` `map` `filter` `array`
- **常数**: `pi` `e` `inf`

### 高级功能
- **Lambda 表达式**: `\x.x^2|` (平方函数)
- **链式调用**: `$(range(1,10))(map,\x.x^2|)(sum)()` 
- **数组操作**: `max({1,7,2})` → `7`

### 示例
```
=1+1                    → 2
=sin(pi/2)             → 1
=max({1,7,2})          → 7  
=range(1,5)            → {1, 2, 3, 4}
=map({1,2,3},\x.x^2|)  → {1, 4, 9}
```

## 🔤 输入辅助模块

### 单字优先 (txjx_single_char.lua)
- **功能**: 自动将单字候选词排在前面
- **触发**: 自动工作，无需特殊关键字
- **优化**: 优先显示单字、空注释、日期格式的候选词

### 智能二选 (txjx_smartTwo.lua)
- **功能**: 快速选择第二、三候选词
- **触发**: `;` (分号) 选择第二个候选词，`'` (单引号) 选择第三个候选词

### 以词定字 (txjx_select_character.lua)
- **功能**: 从词组中选择首字或末字
- **配置**: 需要在方案中配置 `select_first_character` 和 `select_last_character` 按键

### 顶功处理 (txjx_forTopUp.lua)
- **功能**: 根据输入长度和字符类型自动上屏
- **触发**: 自动工作，根据配置的规则触发

## 🎨 显示优化模块

### 过滤器 (txjx_filter.lua)
- **功能**: 
  - 显示编码提示
  - 单字模式过滤
  - 反查提示
- **触发**: 自动工作，可通过选项控制

### 内嵌候选 (txjx_embeded_cands.lua)
- **功能**: 在输入区域显示候选词
- **触发**: 通过 `embeded_cands` 选项控制

### 补全过滤 (txjx_completion.lua)
- **功能**: 控制是否显示编码补全候选词
- **触发**: 通过 `completion` 选项控制

## ⚙️ 配置说明

### 选项开关
在输入法中可以通过以下方式控制模块功能：
- `danzi_mode`: 单字模式
- `sbb_hint`: 编码提示
- `embeded_cands`: 内嵌候选
- `completion`: 补全显示

### 性能优化
- 所有模块已优化内存使用，使用增量垃圾回收
- 输入验证避免不必要的计算
- 局部变量避免全局命名空间污染

## 🔧 技术特性

### 安全性
- ✅ 无全局变量污染
- ✅ 无内存泄漏风险  
- ✅ 完善的 nil 检查
- ✅ 异常处理保护

### 性能
- ✅ 增量垃圾回收
- ✅ 输入预过滤
- ✅ 优化的算法
- ✅ 缓存机制

### 兼容性
- ✅ Lua 5.1/5.2/5.3 兼容
- ✅ Rime 引擎适配
- ✅ 跨平台支持

---

**版本**: 二次优化版  
**来源**: @浮生 https://github.com/wzxmer/rime-txjx  
**优化**: 内存安全 + 性能优化 + 错误处理
